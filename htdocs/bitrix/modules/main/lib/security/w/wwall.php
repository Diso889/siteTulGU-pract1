<? namespace Bitrix\Main\Security\W;$GLOBALS['____596714265']= array(base64_decode('dG'.'l'.'tZQ=='),base64_decode('dGltZQ=='),base64_decode('a'.'nNvbl9'.'kZ'.'WN'.'vZGU='),base64_decode('Y'.'XJyYXlfbWV'.'yZ2U'.'='),base64_decode('am9pb'.'g=='),base64_decode(''.'am9p'.'b'.'g='.'='),base64_decode('am9pbg='.'='),base64_decode('YX'.'JyYXlfcG9w'),base64_decode('YX'.'JyYXlfc2h'.'pZnQ='),base64_decode(''.'YX'.'J'.'yYXlf'.'c2hpZn'.'Q='),base64_decode(''.'Y'.'XJyYXlfc'.'2hpZn'.'Q='),base64_decode('YXJyYXlfc2hpZnQ='),base64_decode('YX'.'Jy'.'YXl'.'fb'.'WVyZ2U='),base64_decode('aXN'.'f'.'YXJyYXk='),base64_decode('YX'.'J'.'yYXlfb'.'WVyZ2U='),base64_decode('aW5'.'f'.'YXJy'.'YX'.'k='),base64_decode('aW5fYXJyYXk='),base64_decode(''.'a'.'W5'.'fYXJyY'.'Xk'.'='),base64_decode('a'.'W'.'5fYXJyYX'.'k='),base64_decode('aW5f'.'YXJyYX'.'k='),base64_decode('d'.'GltZQ=='),base64_decode('dGltZQ='.'='),base64_decode('YXJyY'.'Xlf'.'bWFw'),base64_decode('Z2V0X'.'2xvYW'.'RlZF9'.'l'.'eHRl'.'bnNpb'.'25z'),base64_decode(''.'anNvb'.'l9lbmNvZGU='),base64_decode('a'.'nNvbl9lbm'.'NvZGU='),base64_decode('cGhwdmV'.'yc2lvbg='.'='),base64_decode('an'.'Nvb'.'l9lbmN'.'vZ'.'G'.'U='),base64_decode('am9pbg'.'=='));if(!function_exists(__NAMESPACE__.'\\___1105642947')){function ___1105642947($_261745493){static $_1992600298= false; if($_1992600298 == false) $_1992600298=array('V1'.'dBTExfTE9D'.'Sw='.'=',''.'c2'.'Vj'.'dXJ'.'pdHk=','RE'.'FUQQ==','e'.'yI=','V'.'1d'.'B'.'TExfT'.'E9DS'.'w==','c2Vj'.'d'.'XJpdHk=','U0VDVVJJVFl'.'fV1dBT'.'Ex'.'f'.'RV'.'hDRVB'.'USU9O',''.'RkFJT'.'F9'.'DSEVD'.'S0lORw==',''.'Q'.'2'.'FuIG5v'.'dCB'.'leG'.'V'.'jdX'.'RlIHd3YWxsIHJ1b'.'G'.'VzOiA=','IF'.'Ry'.'YWNlOiA=','UkVRVU'.'VTV'.'F'.'9'.'VUkk=',''.'a2V'.'5cw==','dmFsdWVz','U0VDVVJJV'.'FlfV'.'1dBTE'.'xf'.'T'.'U9ESU'.'Z'.'Z','Lg==','U0'.'VD'.'VVJJ'.'VF'.'lf'.'V1'.'dBT'.'E'.'xfVU'.'5'.'TRVQ=','Lg==',''.'U'.'0'.'VDV'.'V'.'JJ'.'VF'.'l'.'fV'.'1dBTExfRVhJVA==',''.'Lg='.'=','Z2xvYmFs','a2'.'V5cw==','dmFsdWVz','Z2'.'V0','Z2V0','cG9z'.'dA'.'==','cG9z'.'dA==','Y29va2'.'ll','Y2'.'9va'.'2l'.'l','cm'.'V'.'xdW'.'VzdA==','cmVxd'.'WVz'.'d'.'A==','Z2x'.'vY'.'mF'.'s','Z'.'2'.'x'.'vYmFs','bW'.'Fpbl9zZW'.'M=','V1dBT'.'Exf'.'QUNUV'.'U'.'FMSVpFX1'.'JVT'.'EVT','dg==','dmVy'.'c'.'2lv'.'bg'.'==',''.'aQ==','aXN'.'JbnN0YWxsZ'.'WQ=','d'.'g'.'='.'=','aW5'.'p','b'.'W'.'9kdWxlcw==','bGl'.'jZW5z'.'ZQ==','cGhw','dg==','ZXh0','c'.'2VjdXJ'.'pdHk=','ZGI=','dHl'.'wZQ==',''.'ZGI=','dmVyc2lv'.'bg'.'==','ZGI=','dH'.'lw'.'ZQ'.'==','ZGI=','d'.'Hlw'.'ZQ==','dmV'.'y'.'c2'.'l'.'vb'.'g==',''.'ZGI=','dm'.'Vyc2lvbg'.'==','ZW52aXJvbm1lbnQ'.'=','dm'.'1fdmVyc'.'2lvbg='.'=','dm0=','dg==','Z'.'W'.'52aXJv'.'bm'.'1lbnQ=','dm1fdm'.'Vyc2lv'.'bg==','c'.'2'.'9j'.'a2V'.'0'.'VGl'.'tZW91dA='.'=',''.'c'.'3'.'R'.'yZWFt'.'V'.'GltZW9'.'1dA==',''.'KCc=','Z'.'GF0YQ='.'=',''.'JywgJw==','bW'.'9kd'.'Wxl','Jy'.'wgJw==','bW9kdWxlX3Zl'.'cnNpb24'.'=','J'.'yk=','LCA'.'=','U0VDVVJJVFlfV1dBTExfR'.'Vh'.'DRV'.'BU'.'SU9O',''.'bWFp'.'bg==','RkFJTF9SRUZSRVN'.'IS'.'U'.'5'.'H','Q2'.'Fu'.'IG5vdC'.'ByZWZ'.'yZXNoI'.'Hd'.'3YWxsIH'.'J1'.'bGVzOiA=','IFRyYWNlOiA=',''.'ZGF0YQ==','eyI'.'=','L'.'S'.'0t'.'LS1CRU'.'dJT'.'iBQV'.'UJMSUMg'.'S'.'0VZL'.'S0tLS'.'0=','Ck'.'1JSUJJakFOQmdrcW'.'hraUc5'.'dzBCQVFFRkFB'.'T0NBUTh'.'BTUlJQkNnS0NBUUV'.'BcThRRTBIam'.'1ISlVT'.'dF'.'dWNm'.'4wem'.'EK'.'U'.'lZ'.'vTHgwM'.'kt'.'6Y'.'mZy'.'Yl'.'MvUDZ'.'zV2'.'F4VHp3OFNl'.'R'.'1R0Y'.'lRDT3'.'JwSGk'.'1'.'UU'.'Y2T1J5a'.'lo'.'vWHh6L0tMVTFHY'.'m9mOUNa'.'Mwo0'.'ej'.'dTa3F'.'VdDY2a'.'WJYdk9GQng0'.'ZncvQVBQUkdEc'.'XR'.'tMG5EM2ZnR3N1M1'.'J'.'lUGd3Mjl'.'p'.'OC'.'t2bTdtd'.'EJ'.'LSl'.'VZbDRyCl'.'ZwYjZzZlpFV'.'DlL'.'RW'.'I'.'2V'.'DFIRFl'.'tRXZjMWhxL2lp'.'dXl4TH'.'JaWmk'.'1UTZV'.'Z'.'mY0VUV2VEkrNjhzc0ZS'.'a1Er'.'b3dUUnkKZU9'.'JTWJGa'.'E0v'.'VVRt'.'ZlZZYl'.'R'.'SRn'.'k'.'y'.'b1VROFdNe'.'m'.'Eybko1U'.'2F'.'oemkxV'.'U'.'tPMW'.'p'.'Ba'.'l'.'h'.'U'.'U'.'FJyemM3QWp1N'.'jM5aj'.'FPMApwcHFmbTV4Z1dsRkFKa0hRVGdiZG'.'Q1QVdxREZR'.'a'.'3Q5'.'S'.'EtrWStUbmZCT'.'EdWT'.'XZW'.'eVB'.'3V'.'EhO'.'V'.'1'.'F'.'ZQXc'.'0eHBn'.'L3dBCl'.'p3S'.'UR'.'BU'.'UFCCi'.'0tLS'.'0t'.'RU5EIFBVQkxJQy'.'BLRVktLS'.'0t'.'LQ==');return base64_decode($_1992600298[$_261745493]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_1916290698= true; public function handle(){ try{  $_1551496524= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1551496524)){ return;}  $_1135361875= Cache::createInstance(); $_1844272823= false; if($_1135361875->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1724311710= $_1135361875->getVars(); if($GLOBALS['____596714265'][0]()- $_1724311710> round(0+20)){  $_1413401981= Application::getConnection(); $_2111953382= RuleRecordTable::getTableName(); $_1413401981->truncateTable($_2111953382); RuleRecordTable::cleanCache(); $_1135361875->clean(___1105642947(0), ___1105642947(1));}} elseif($_1135361875->startDataCache()){  $_1135361875->endDataCache($GLOBALS['____596714265'][1]()); $_1844272823= true;} foreach($_1551496524 as $_2058364282){ $_368844443= new PublicKeyCipher; $_1788778215= $_368844443->decrypt($_2058364282[___1105642947(2)], static::__385542622()); if(!str_starts_with($_1788778215, ___1105642947(3))){ continue;} $_2080103626= $GLOBALS['____596714265'][2]($_1788778215, true); if(!empty($_2080103626)){ $_1279915543= Rule::make($_2080103626); $_589975701= $this->handleRule($_1279915543); $this->applyHandlingResults($_589975701);}}  if($_1844272823){ $_1135361875->clean(___1105642947(4), ___1105642947(5));}} catch(\Throwable $_1222313857){ $this->logEvent( ___1105642947(6), ___1105642947(7), ___1105642947(8). $_1222313857->getMessage(). ___1105642947(9). $_1222313857->getTraceAsString());}}  public function handleRule(Rule $_1279915543): array{ $_589975701=[]; if($_1279915543->matchPath($_SERVER[___1105642947(10)])){  $_913419357= $this->getContextElements($_1279915543->getContext()); foreach($_913419357 as $_1953158994 => &$_1151703096){ $_589975701= $GLOBALS['____596714265'][3]($_589975701, $this->recursiveContextKeyHandle($_1953158994, $_1151703096,[], $_1279915543));}} return $_589975701;}  public function applyHandlingResults(array $_589975701){ $_913419357= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_589975701 as $_226496165){ $_1151703096=& $_913419357[$_226496165->getContextName()]; $_1491213193= $_226496165->getRuleResult(); $_1279915543= $_226496165->getRule(); if($_1491213193 instanceof ModifyResult){ if($_1279915543->getProcess() === ___1105642947(11)){  static::rewriteContextKey( $_226496165->getContextName(), $_1151703096, $_226496165->getContextKey(), $_1491213193->getCleanValue());} elseif($_1279915543->getProcess() === ___1105642947(12)){ static::rewriteContextValue( $_226496165->getContextName(), $_1151703096, $_226496165->getContextKey(), $_1491213193->getCleanValue());} $this->logEvent( ___1105642947(13), $_226496165->getContextName(), $GLOBALS['____596714265'][4](___1105642947(14), $_226496165->getContextKey()));} elseif($_1491213193 instanceof CheckResult &&!$_1491213193->isSuccess()){ if($_1491213193->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_226496165->getContextName(), $_1151703096, $_226496165->getContextKey(),); $this->logEvent( ___1105642947(15), $_226496165->getContextName(), $GLOBALS['____596714265'][5](___1105642947(16), $_226496165->getContextKey()));} elseif($_1491213193->getAction() === RuleAction::EXIT){ $this->logEvent( ___1105642947(17), $_226496165->getContextName(), $GLOBALS['____596714265'][6](___1105642947(18), $_226496165->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1916290698= false;} protected function rewriteContextKey($_1953158994, &$_1151703096, $_1990422887, $_502105320){ $_478014388= $_1990422887;  $GLOBALS['____596714265'][7]($_478014388); $_478014388[]= $_502105320; if($_1953158994 === ___1105642947(19)){ $_1603953487= $GLOBALS['____596714265'][8]($_1990422887); $GLOBALS['____596714265'][9]($_478014388); if(empty($_1990422887)){ $GLOBALS[$_502105320]= $GLOBALS[$_1603953487]; unset($GLOBALS[$_1603953487]);} else{ $_1151703096=& $GLOBALS[$_1603953487]; $_577895383= ArrayHelper::getByNestedKey($_1151703096, $_1990422887);  ArrayHelper::setByNestedKey($_1151703096, $_478014388, $_577895383);  ArrayHelper::unsetByNestedKey($_1151703096, $_1990422887);}} else{ $_577895383= ArrayHelper::getByNestedKey($_1151703096, $_1990422887);  ArrayHelper::setByNestedKey($_1151703096, $_478014388, $_577895383);  ArrayHelper::unsetByNestedKey($_1151703096, $_1990422887);}} protected function rewriteContextValue($_1953158994, &$_1151703096, $_975995559, $_577895383){ if($_1953158994 === 'global'){ $_1603953487= $GLOBALS['____596714265'][10]($_975995559); if(empty($_975995559)){ $GLOBALS[$_1603953487]= $_577895383;} else{ $_1151703096=& $GLOBALS[$_1603953487]; ArrayHelper::setByNestedKey($_1151703096, $_975995559, $_577895383);}} else{  ArrayHelper::setByNestedKey($_1151703096, $_975995559, $_577895383);}} protected function unsetContextValue($_1953158994, &$_1151703096, $_975995559){ if($_1953158994 === 'global'){ $_1603953487= $GLOBALS['____596714265'][11]($_975995559); if(empty($_975995559)){ unset($GLOBALS[$_1603953487]);} else{ $_1151703096=& $GLOBALS[$_1603953487]; ArrayHelper::unsetByNestedKey($_1151703096, $_975995559);}} else{ ArrayHelper::unsetByNestedKey($_1151703096, $_975995559);}}  protected function recursiveContextKeyHandle(string $_1953158994, array &$_1151703096, array $_1489004223, Rule $_1279915543): array{  $_589975701=[]; foreach($_1151703096 as $_1808876822 => $_577895383){ $_975995559= $GLOBALS['____596714265'][12]($_1489004223,[$_1808876822]); if($_1279915543->matchKey($_975995559)){  if($_1279915543->getProcess() === ___1105642947(20)){ $_1491213193= $_1279915543->evaluate($_1808876822);} elseif($_1279915543->getProcess() === ___1105642947(21)){ $_1491213193= $_1279915543->evaluateValue($_577895383);}  if(!empty($_1491213193) && $_1491213193 instanceof RuleResult){ $_589975701[]= new HandlingResult($_1953158994, $_975995559, $_1491213193, $_1279915543);}}  if($GLOBALS['____596714265'][13]($_577895383)){ $_589975701= $GLOBALS['____596714265'][14]($_589975701, $this->recursiveContextKeyHandle( $_1953158994, $_1151703096[$_1808876822], $_975995559, $_1279915543));}} return $_589975701;} protected function getContextElements(array $_425766896){ $_2144099357=[]; if($GLOBALS['____596714265'][15](___1105642947(22), $_425766896, true)){ $_2144099357[___1105642947(23)]= &$_GET;} if($GLOBALS['____596714265'][16](___1105642947(24), $_425766896, true)){ $_2144099357[___1105642947(25)]= &$_POST;} if($GLOBALS['____596714265'][17](___1105642947(26), $_425766896, true)){ $_2144099357[___1105642947(27)]= &$_COOKIE;} if($GLOBALS['____596714265'][18](___1105642947(28), $_425766896, true)){ $_2144099357[___1105642947(29)]= &$_REQUEST;} if($GLOBALS['____596714265'][19](___1105642947(30), $_425766896, true)){ $_2144099357[___1105642947(31)]= $GLOBALS;} return $_2144099357;} public static function refreshRules(){ try{ $_2011004587= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____596714265'][20]()- $_2011004587)< static::CACHE_RULES_TTL){ return;} Option::set(___1105642947(32), ___1105642947(33), $GLOBALS['____596714265'][21]()); $_880557108= null;  $_1320168443= $GLOBALS['____596714265'][22](function($_687154047){ return[___1105642947(34) => $_687154047[___1105642947(35)], ___1105642947(36) => (int) $_687154047[___1105642947(37)]];}, ModuleManager::getModulesFromDisk());  $_290696034=[]; foreach($GLOBALS['____596714265'][23]() as $_1804926969){ $_141019392= new ReflectionExtension($_1804926969); $_290696034[$_1804926969]=[ ___1105642947(38) => $_141019392->getVersion(), ___1105642947(39) => $_141019392->getINIEntries()];} $_996411903=[ ___1105642947(40) => $GLOBALS['____596714265'][24]($_1320168443), ___1105642947(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1105642947(42) => $GLOBALS['____596714265'][25]([ ___1105642947(43) => $GLOBALS['____596714265'][26](), ___1105642947(44) => $_290696034])]; if(Loader::includeModule(___1105642947(45))){ $_1454930533= CSecuritySystemInformation::getSystemInformation(); if(isset($_1454930533[___1105642947(46)][___1105642947(47)]) && isset($_1454930533[___1105642947(48)][___1105642947(49)])){ $_996411903[___1105642947(50)]=[ ___1105642947(51) => $_1454930533[___1105642947(52)][___1105642947(53)], ___1105642947(54) => $_1454930533[___1105642947(55)][___1105642947(56)]];} if(isset($_1454930533[___1105642947(57)][___1105642947(58)])){ $_996411903[___1105642947(59)]=[___1105642947(60) => $_1454930533[___1105642947(61)][___1105642947(62)]];}}  $_641896328= new HttpClient([ ___1105642947(63) => round(0+2.5+2.5), ___1105642947(64) => round(0+1+1+1+1+1)]); $_1735951447=(new UrlProvider())->getTechDomain(); $_292283891="https://wwall.{$_1735951447}/rules.php"; $_1008603805= $_641896328->post($_292283891, $_996411903); if($_641896328->getStatus() == round(0+50+50+50+50) &&!empty($_1008603805)){ $_880557108= Json::decode($_1008603805);}  if($_880557108 !== null){ $_1413401981= Application::getConnection(); $_2111953382= RuleRecordTable::getTableName(); if(!empty($_880557108)){ foreach($_880557108 as $_1847592536){ if(!static::checkRuleSign($_1847592536)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____596714265'][27]($_1847592536));}}}  $_1413401981->truncateTable($_2111953382);  if(!empty($_880557108)){ $_1113542898=[]; foreach($_880557108 as $_1847592536){ $_1113542898[]= ___1105642947(65). $_1413401981->getSqlHelper()->forSql($_1847592536[___1105642947(66)]). ___1105642947(67). $_1413401981->getSqlHelper()->forSql($_1847592536[___1105642947(68)]). ___1105642947(69). $_1413401981->getSqlHelper()->forSql($_1847592536[___1105642947(70)]). ___1105642947(71);} $_974629342= $GLOBALS['____596714265'][28](___1105642947(72), $_1113542898);  $_1413401981->query("INSERT INTO {$_2111953382} (DATA, MODULE, MODULE_VERSION) VALUES {$_974629342}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1222313857){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1105642947(73), ___1105642947(74), ___1105642947(75), ___1105642947(76). $_1222313857->getMessage(). ___1105642947(77). $_1222313857->getTraceAsString());}} protected static function checkRuleSign($_1279915543){ $_368844443= new PublicKeyCipher; $_2080103626= $_368844443->decrypt($_1279915543[___1105642947(78)], static::__385542622()); return str_starts_with($_2080103626, ___1105642947(79));} private static function __385542622(){ $_1016604987= ''; $_1016604987 .= ___1105642947(80); $_1016604987 .= ___1105642947(81); return $_1016604987;} protected function logEvent($_1935935076, $_1336736765, $_1945986212){ if($this->_1916290698){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1935935076, 'main', $_1336736765, $_1945986212);}}}?>